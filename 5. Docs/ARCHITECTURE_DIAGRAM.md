# Architecture Diagram: ICurrentTenant Separation

```
???????????????????????????????????????????????????????????????????????????
?                            Craft.Core                                    ?
?  ??????????????????????????????????????????????????????????????????    ?
?  ?   ICurrentTenant<TKey>                                          ?    ?
?  ?   ????????????????????????????????????????????????????????     ?    ?
?  ?   ?  + Id: TKey                                           ?     ?    ?
?  ?   ?  + Identifier: string?                                ?     ?    ?
?  ?   ?  + Name: string?                                      ?     ?    ?
?  ?   ?  + IsAvailable: bool                                  ?     ?    ?
?  ?   ?  + IsActive: bool                                     ?     ?    ?
?  ?   ?  + GetId(): TKey                                      ?     ?    ?
?  ?   ????????????????????????????????????????????????????????     ?    ?
?  ?                                                                  ?    ?
?  ?   ICurrentTenant : ICurrentTenant<KeyType>                     ?    ?
?  ??????????????????????????????????????????????????????????????????    ?
?                                                                          ?
?  Lightweight interface with essential properties only                   ?
?  No dependencies on multi-tenant infrastructure                         ?
???????????????????????????????????????????????????????????????????????????
                                    ?
                                    ? implements
                                    ?
???????????????????????????????????????????????????????????????????????????
?                       Craft.MultiTenant                                  ?
?                                                                          ?
?  ??????????????????????????????????????????????????????????????????    ?
?  ?   CurrentTenant<TKey> : ICurrentTenant<TKey>                   ?    ?
?  ?   ????????????????????????????????????????????????????????     ?    ?
?  ?   ?  - _contextAccessor: ITenantContextAccessor           ?     ?    ?
?  ?   ?                                                        ?     ?    ?
?  ?   ?  + Id: TKey                                           ?     ?    ?
?  ?   ?      => _contextAccessor.TenantContext?.Tenant?.Id   ?     ?    ?
?  ?   ?                                                        ?     ?    ?
?  ?   ?  + Identifier: string?                                ?     ?    ?
?  ?   ?      => _contextAccessor.TenantContext?.Tenant        ?     ?    ?
?  ?   ?           ?.Identifier                                ?     ?    ?
?  ?   ?                                                        ?     ?    ?
?  ?   ?  ... (wraps full tenant properties)                   ?     ?    ?
?  ?   ????????????????????????????????????????????????????????     ?    ?
?  ?                                                                  ?    ?
?  ?   CurrentTenant : CurrentTenant<KeyType>                        ?    ?
?  ??????????????????????????????????????????????????????????????????    ?
?                                                                          ?
?  ??????????????????????????????????????????????????????????????????    ?
?  ?   ITenant<TKey> : ISoftDelete, IHasConcurrency, IEntity, ...   ?    ?
?  ?   ????????????????????????????????????????????????????????     ?    ?
?  ?   ?  + Id: TKey                                           ?     ?    ?
?  ?   ?  + Identifier: string                                 ?     ?    ?
?  ?   ?  + Name: string                                       ?     ?    ?
?  ?   ?  + ConnectionString: string                           ?     ?    ?
?  ?   ?  + DbProvider: string                                 ?     ?    ?
?  ?   ?  + DbType: TenantDbType                               ?     ?    ?
?  ?   ?  + Type: TenantType                                   ?     ?    ?
?  ?   ?  + AdminEmail: string                                 ?     ?    ?
?  ?   ?  + LogoUri: string                                    ?     ?    ?
?  ?   ?  + ValidUpTo: DateTime                                ?     ?    ?
?  ?   ?  + IsActive: bool                                     ?     ?    ?
?  ?   ?  + IsDeleted: bool                                    ?     ?    ?
?  ?   ?  + ConcurrencyStamp: string?                          ?     ?    ?
?  ?   ????????????????????????????????????????????????????????     ?    ?
?  ??????????????????????????????????????????????????????????????????    ?
?                                                                          ?
?  ??????????????????????????????????????????????????????????????????    ?
?  ?   ITenantContextAccessor                                        ?    ?
?  ?   ????????????????????????????????????????????????????????     ?    ?
?  ?   ?  + TenantContext: ITenantContext?                     ?     ?    ?
?  ?   ????????????????????????????????????????????????????????     ?    ?
?  ??????????????????????????????????????????????????????????????????    ?
?                                                                          ?
?  Full multi-tenant infrastructure with stores, strategies, etc.         ?
???????????????????????????????????????????????????????????????????????????
                                    ?
                                    ? uses both
                                    ?
???????????????????????????????????????????????????????????????????????????
?                          Craft.Data                                      ?
?                                                                          ?
?  ??????????????????????????????????????????????????????????????????    ?
?  ?   TenantDbContextFactory<T>                                     ?    ?
?  ?   ????????????????????????????????????????????????????????     ?    ?
?  ?   ?  - _currentTenant: ICurrentTenant                     ?     ?    ?
?  ?   ?      (for logging and identification)                 ?     ?    ?
?  ?   ?                                                        ?     ?    ?
?  ?   ?  - _tenantContextAccessor: ITenantContextAccessor     ?     ?    ?
?  ?   ?      (for full tenant details: ConnectionString,      ?     ?    ?
?  ?   ?       DbProvider, DbType)                             ?     ?    ?
?  ?   ?                                                        ?     ?    ?
?  ?   ?  + CreateDbContext(): T                               ?     ?    ?
?  ?   ????????????????????????????????????????????????????????     ?    ?
?  ??????????????????????????????????????????????????????????????????    ?
?                                                                          ?
?  ??????????????????????????????????????????????????????????????????    ?
?  ?   QueryFilterExtension                                          ?    ?
?  ?   ????????????????????????????????????????????????????????     ?    ?
?  ?   ?  + AddGlobalTenantFilter(                             ?     ?    ?
?  ?   ?      ModelBuilder, ICurrentTenant)                    ?     ?    ?
?  ?   ?      => filters by ICurrentTenant.Id                  ?     ?    ?
?  ?   ????????????????????????????????????????????????????????     ?    ?
?  ??????????????????????????????????????????????????????????????????    ?
?                                                                          ?
?  Database layer uses lightweight interface for basic tenant info        ?
?  and full accessor when connection details are needed                   ?
???????????????????????????????????????????????????????????????????????????
```

## Dependency Flow

```
????????????????
?  Craft.Core  ?  ? Base layer, no dependencies
????????????????
       ?
       ? references
       ?
????????????????????
? Craft.MultiTenant?  ? Implements ICurrentTenant from Craft.Core
????????????????????
       ?
       ? references
       ?
????????????????
?  Craft.Data  ?  ? Uses both ICurrentTenant and ITenantContextAccessor
????????????????
```

## Usage Scenarios

### Scenario 1: Basic Tenant Info Only
**Project**: Craft.Logging, Craft.Auditing, or any service layer
**Reference**: Craft.Core only
**Inject**: `ICurrentTenant`
**Access**: Id, Identifier, Name, IsAvailable, IsActive

```csharp
using Craft.Core;

public class AuditService
{
    private readonly ICurrentTenant _tenant;
    
    public void LogAction(string action)
    {
        var tenantId = _tenant.Id;
        var tenantName = _tenant.Name;
        // Log with tenant context
    }
}
```

### Scenario 2: Full Tenant Management
**Project**: Tenant administration services
**Reference**: Craft.MultiTenant
**Inject**: `ITenantContextAccessor`
**Access**: Full ITenant with all properties

```csharp
using Craft.MultiTenant;

public class TenantConfigService
{
    private readonly ITenantContextAccessor _accessor;
    
    public string GetConnectionString()
    {
        return _accessor.TenantContext?.Tenant?.ConnectionString;
    }
}
```

### Scenario 3: Combined Usage
**Project**: Data access layer (Craft.Data)
**Reference**: Craft.Core + Craft.MultiTenant
**Inject**: Both `ICurrentTenant` and `ITenantContextAccessor`
**Access**: Basic info for logging, full details for connections

```csharp
using Craft.Core;
using Craft.MultiTenant;

public class TenantDbContextFactory
{
    private readonly ICurrentTenant _currentTenant;
    private readonly ITenantContextAccessor _accessor;
    
    public DbContext CreateDbContext()
    {
        // Use lightweight for logging
        _logger.LogDebug("Creating context for {Tenant}", 
            _currentTenant.Name);
        
        // Use full accessor for connection
        var fullTenant = _accessor.TenantContext?.Tenant;
        var connectionString = fullTenant?.ConnectionString;
        
        // ...
    }
}
```

## Key Design Principles

1. **Single Responsibility**: 
   - `ICurrentTenant`: Provides tenant identification
   - `ITenant`: Full tenant entity with all properties
   - `ITenantContextAccessor`: Provides access to full tenant context

2. **Dependency Inversion**:
   - Higher-level services depend on abstractions (ICurrentTenant)
   - Lower-level implementation (CurrentTenant) implements the abstraction

3. **Interface Segregation**:
   - Small, focused interface (ICurrentTenant) for most consumers
   - Full interface (ITenant) only when needed

4. **Open/Closed Principle**:
   - Adding new tenant properties to ITenant doesn't affect ICurrentTenant consumers
   - New functionality can be added without breaking existing code
