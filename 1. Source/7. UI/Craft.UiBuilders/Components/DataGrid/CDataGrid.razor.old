@namespace ChalkBlazor

@typeparam TableItem

<SpinLoader IsLoading="@(_entities == null)">
    <ContentTemplate>
        @if (_filteredFields.Count > 0)
        {
            <div class="text-end cb-text-sm">
                @foreach (var item in _filteredFields)
                {
                    <CbTag Class="me-3" Text="@item" IsDismissible="true" OnDismiss="RemoveFilter" Color="Color.Info"></CbTag>
                }

                @*Display A Clear All filter Button*@
                <CbButton OnClick="@ClearFilters" TextButton="true">Clear All</CbButton>
            </div>

        }

        <CascadingValue Value="(IDataGrid<TableItem>)this" Name="Table" IsFixed="true">
            @ChildContent
        </CascadingValue>

        @if (Columns.Any())
        {
            @if (_entities != null && _entities.Count != 0)
            {

                <table role="grid" class="@ClassName" @attributes="UnknownParameters">
                    <thead>
                        <tr>
                            @*Add This Column Only When We Have An action Item*@
                            @if (EditIcon || DeleteIcon)
                            {
                                <th class="text-center" style="width: 5rem;">
                                    Actions
                                </th>
                            }

                            @foreach (IColumn<TableItem> column in Columns)
                            {
                                if (column.Caption.ToLower() == "id")
                                    continue;

                                <th scope="col" style="cursor: pointer; @(column.Width.IsNonEmpty() ? $"width:{column.Width}" : "")"
                        class="@column.Align.GetDescription() text-truncate">
                                    <div @onclick="@( () => SortTable(column))">

                                        @if (column.Align != Alignment.Right)
                                            @column.Caption


                                            <CbSortIcon Class="ms-auto" SortDirection="@column.SortDirection"></CbSortIcon>

                                            @if (column.Align == Alignment.Right)
                                            @column.Caption


                                        </div>
                                    </th>
                            }
                        </tr>
                    </thead>

                    <tbody>
                        @if (_entities != null && _entities.Count != 0)
                        {
                            @foreach (TableItem item in _entities)
                            {
                                <tr>
                                    @foreach (IColumn<TableItem> column in Columns)
                                    {
                                        if (column.Caption.ToLower() == "id")
                                        {
                                            @*Add This Column Only When We Have An action Item*@
                                            if (EditIcon || DeleteIcon)
                                            {
                                                <td class="text-center">
                                                    @if (ReadIcon)
                                                    {
                                                        <a href="@(String.Format(ReadURI, column.Render(item)))">
                                                            <CbIcon Icon="@CbConstants.ReadIcon" Class="me-2" />
                                                        </a>
                                                    }

                                                    @if (EditIcon)
                                                    {
                                                        <a @onclick="@(()=>OnEdit(column.Render(item),String.Format(EditURI, column.Render(item))))">
                                                            <CbIcon Icon="@CbConstants.EditIcon" Class="me-2" />
                                                        </a>
                                                    }

                                                    @if (DeleteIcon)
                                                    {
                                                        <a @onclick="@( () => DeleteEntity(int.Parse(column.Render(item))))">
                                                            <CbIcon Icon="@CbConstants.DeleteIcon" Color="Color.Danger" />
                                                        </a>
                                                    }
                                                </td>
                                            }
                                        }
                                        else
                                        {
                                            <td class="@column.Align.GetDescription() text-truncate">
                                                @if (column.Template == null)
                                                {
                                                    @column.Render(item)
                                                }
                                                else
                                                {
                                                    @column.Template(item)
                                                }
                                            </td>
                                        }
                                    }
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            }
            else
            {
                <CbAlert Icon="@CbConstants.InfoIcon" Color="Color.Secondary" IsDismissible="false">
                    There are no records available
                </CbAlert>
            }

            <CbGridRow>
                <CbGridCol XS="6" SM="6" MD="4" Class="d-flex text-start align-items-center">
                    @if (AddButton && AddURI.IsNonEmpty())
                    {
                        <CbButton Color="Color.Primary" OnClick="@AddEntity"
                          StartIcon="@ButtonIcon" Class="me-3">@ButtonName</CbButton>
                    }

                    @if (CancelButton && CancelURI.IsNonEmpty() && !Linked || (Linked && ReturnRouter != null))
                    {
                        <CbButton Color="Color.Default" OnClick="@CancelRoute"
                          StartIcon="@CbConstants.CancelIcon">Cancel</CbButton>
                    }
                </CbGridCol>

                @if (Pagination)
                {
                    <CbGridCol XS="6" SM="6" MD="4" Class="d-flex align-items-center justify-content-end justify-content-md-center">
                        <label class="cb-secondary-text me-2" for="PageSize">Page Size: </label>
                        <select class="d-flex form-select" name="PageSize" id="PageSize" style="width: 120px;" @onchange="@ChangePageSize">
                            <option value="10">10 Items</option>
                            <option value="20">20 Items</option>
                            <option value="25">25 Items</option>
                            <option value="50">50 Items</option>
                        </select>
                    </CbGridCol>

                    <CbGridCol XS="12" SM="12" MD="4" Class="d-flex align-items-center justify-content-md-end justify-content-center">
                        <CbPagination Spacing="true"
                              OnFirstClick="@FirstPage"
                              OnPrevClick="@PreviousPage"
                              OnNextClick="@NextPage"
                              OnLastClick="@LastPage"
                              CurrentPage="@_paginationInfo.CurrentPage"
                              TotalPages="@_paginationInfo.TotalPages">
                        </CbPagination>
                    </CbGridCol>
                }
            </CbGridRow>
        }
    </ContentTemplate>
</SpinLoader>

<CbYesNoDialog Title="Delete Record" ShowDialog="_showYesNoDialog" YesNo="true" OnClick="DeleteEntityAsync"
               Message="Do you want to delete this record" />

<CbSearch ShowDialog="_showSearchDialog" TableItem="TableItem" FieldsList="_filterFields" OnOkay="AddFilter" FieldNamesList="_filterFieldNames" />


<CbExportDialog ShowDialog="_showExportDialog" OnClick="ExportData" />
