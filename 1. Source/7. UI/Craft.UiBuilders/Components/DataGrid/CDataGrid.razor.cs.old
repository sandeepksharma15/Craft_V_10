using ChalkERP.Core;
using ChalkERP.Core.Util;
using System.Text;

#nullable disable

namespace ChalkBlazor
{
    public partial class CDataGrid<TableItem> : ComponentBase, IDataGrid<TableItem>
    {
        private bool _filterEnabled;
        private List<TableItem> _entities;
        private PaginationInfo _paginationInfo;
        private readonly List<IColumn<TableItem>> _sortFields = new List<IColumn<TableItem>>();
        private readonly List<IColumn<TableItem>> _filterFields = new List<IColumn<TableItem>>();
        private bool _showYesNoDialog = false;
        private int? _currentEntityId;
        private bool _showSearchDialog = false;
        private bool _showExportDialog = false;
        private readonly List<string> _filterFieldNames = new List<string>();
        private List<string> _filterList = new List<string>();
        private readonly List<string> _userFilterList = new List<string>();
        private readonly List<string> _filteredFields = new List<string>();

        public delegate Task<string> RreturnRouter(string url);
        public delegate IEnumerable<TableItem> PagedListDelegate(int currentPage,
                                           int pageSize,
                                           string orderList,
                                           List<string> filterList,
                                           out PaginationInfo paginationInfo);

        public delegate Task<HttpResponseMessage> DeleteDelegate(int? Id);

        [Inject] private NavigationManager _navigationManager { get; set; }
        [Inject] private IToastService _toastService { get; set; }

        [Parameter(CaptureUnmatchedValues = true)]
        public IReadOnlyDictionary<string, object> UnknownParameters { get; set; }

        [Parameter] public PagedListDelegate PagedListMethod { get; set; }
        [Parameter] public RenderFragment ChildContent { get; set; }
        [Parameter] public int PageSize { get; set; } = CbConstants.DefaultPageSize;
        [Parameter] public int CurrentPage { get; set; } = 1;
        [Parameter] public bool Pagination { get; set; } = true;
        [Parameter] public bool Hoverable { get; set; }
        [Parameter] public bool Striped { get; set; }
        [Parameter] public bool Bordered { get; set; }
        [Parameter] public bool FullWidth { get; set; }
        [Parameter] public string Class { get; set; }
        [Parameter] public bool ReadIcon { get; set; }
        [Parameter] public string ReadURI { get; set; }
        [Parameter] public bool EditIcon { get; set; }
        [Parameter] public bool EditIconForPopUp { get; set; }
        [Parameter] public string EditURI { get; set; }
        [Parameter] public string RecordId { get; set; }
        [Parameter] public EventCallback<KeyValuePair<int, string>> EditEventCallBack { get; set; }
        [Parameter] public bool DeleteIcon { get; set; }
        [Parameter] public bool AddButton { get; set; }
        [Parameter] public string AddURI { get; set; }
        [Parameter] public bool CancelButton { get; set; }
        [Parameter] public string CancelURI { get; set; } = "/Dashboard";
        [Parameter] public DeleteDelegate DeleteMethod { get; set; }
        [Parameter] public List<string> FilterList { get; set; }
        [Parameter] public ContentHeader ContentHeaderRef { get; set; }
        [Parameter] public string _orderList { get; set; } = "Id";
        [Parameter] public RreturnRouter ReturnRouter { get; set; }
        [Parameter] public bool Linked { get; set; }
        [Parameter] public string ButtonName { get; set; } = "Add New";
        [Parameter] public string ButtonIcon { get; set; } = CbConstants.NewIcon;

        private event RreturnRouter _call;


        public int TotalCount { get; private set; }

        public List<IColumn<TableItem>> Columns { get; } = new List<IColumn<TableItem>>();

        protected override void OnParametersSet()
        {
            // Keep A Copy Or Original Filter List
            _filterList = FilterList?.ToList();

            // Set The Export Click CallBack
            if (ContentHeaderRef != null)
            {
                ContentHeaderRef.ShowExportIcon(true);
                ContentHeaderRef.SetOnExportClickCallback(new EventCallback(this, ShowExportDialog));
            }

            // Get The Data
            GetData();
        }

        private void FilterGrid()
        {
            // Show The Search Dialog
            _showSearchDialog = true;
        }

        private void ShowExportDialog()
        {
            // Show The Export Dialog
            _showExportDialog = true;
        }

        private void ExportData(ExportType exportType)
        {
            if (exportType == ExportType.ThisPage)
            {
                // TODO: Implement This
            }

            if (exportType == ExportType.AllPages)
            {
                // TODO: Implement This
            }
        }

        private void AddFilter(SearchEventArgs searchEventArgs)
        {
            // Hide The Search Dialog
            _showSearchDialog = false;

            if (searchEventArgs.Field is not null)
            {
                // Add The New Filter
                try
                {
                    string filter = GetFilter(searchEventArgs);

                    if (filter.IsNonEmpty())
                    {
                        // Add To The Filtered Fields' List
                        _filteredFields.Add(searchEventArgs.Field);

                        // Keep A List Of User Filters
                        _userFilterList.Add(filter);

                        // Add To The Master Filter List
                        (FilterList ??= new List<string>()).Add(filter);
                        GetData();
                    }
                }
                catch
                {
                    // This Is To Avoid any Runtime Error Which Is Possible Because Of Erroneous User Input
                }
            }
        }

        private void RemoveFilter(string field)
        {
            string filter;
            System.Reflection.MemberInfo prop = Columns.Find(x => x.Caption == field).Field
                                 .GetPropertyMemberInfo<TableItem>();

            // Remove From Filtered Fields
            _filteredFields.RemoveAll(x => x == field);
            field = field.Replace(" ", "");

            // Remove From User Filters & Master Filters
            while ((filter = _userFilterList.Find(x => x.Contains(field))).IsNonEmpty())
            {
                _userFilterList.Remove(filter);
                FilterList.Remove(filter);
            }
            GetData();
        }

        private void ClearFilters()
        {
            _filteredFields.Clear();
            _userFilterList.Clear();
            FilterList = _filterList?.ToList();
            GetData();
        }

        private string GetFilter(SearchEventArgs searchEventArgs)
        {
            string filter;
            System.Reflection.MemberInfo prop = Columns.Find(x => x.Caption == searchEventArgs.Field).Field
                                     .GetPropertyMemberInfo<TableItem>();
            string name = prop.Name;
            Type type = prop.GetMemberUnderlyingType();
            object compareWith = searchEventArgs.Value;

            if (type.IsEnum)
            {
                type = typeof(int);
                compareWith = (int)compareWith;
                filter = $"{type.FullName},{name},{compareWith},{(byte)searchEventArgs.ComparisonType}";
            }

            else if (type.Equals(typeof(DateOnly)))
            {
                filter = $"{type.FullName},{name},{searchEventArgs.Date},{(byte)searchEventArgs.ComparisonType}";
            }

            else if (type.Equals(typeof(TimeOnly)))
            {
                filter = $"{type.FullName},{name},{searchEventArgs.Time},{(byte)searchEventArgs.ComparisonType}";
            }

            else if (type.Equals(typeof(bool)))
            {
                filter = $"{type.FullName},{name},{searchEventArgs.Bool},{(byte)searchEventArgs.ComparisonType}";
            }

            else
            {
                if (Nullable.GetUnderlyingType(type) != null)
                {
                    type = type.GetNonNullableType();
                }

                filter = $"{type.FullName},{name},{compareWith},{(byte)searchEventArgs.ComparisonType}";
            }

            // Ensure That Value Is Of The Right Type
            try
            {
                if (type.Equals(typeof(DateOnly)))
                { _ = Convert.ChangeType(searchEventArgs.Date, type); }

                else if (type.Equals(typeof(TimeOnly)))
                { _ = Convert.ChangeType(searchEventArgs.Time, type); }

                else if (type.Equals(typeof(bool)))
                { _ = Convert.ChangeType(searchEventArgs.Bool, type); }

                else
                { _ = Convert.ChangeType(compareWith, type); }
            }
            catch
            {
                filter = string.Empty;
            }

            return filter;
        }

        public void AddColumn(IColumn<TableItem> column)
        {
            column.Table = this;

            if (column.Type == null)
            {
                column.Type = column.Field?.GetPropertyMemberInfo().GetMemberUnderlyingType();
            }

            if ((column.Filterable) && (column.Field != null))
            {
                _filterFields.Add(column);
                _filterFieldNames.Add(column.Caption);

                if (!_filterEnabled)
                {
                    _filterEnabled = true;
                    if (ContentHeaderRef != null)
                    {
                        ContentHeaderRef.ShowSearchIcon(true);
                        ContentHeaderRef.SetOnSearchClickCallback(new EventCallback(this, FilterGrid));
                    }
                }
            }

            if (column.DefaultSortColumn == true && column.Field != null)
            {
                _sortFields.Add(column);

                _orderList = column.Field.GetPropertyMemberInfo().Name;

                if (column.DefaultSortDescending == true)
                {
                    _orderList += " DESC";
                }

                // GetData();
            }

            Columns.Add(column);
            Refresh();
        }

        public void RemoveColumn(IColumn<TableItem> column)
        {
            Columns.Remove(column);
            Refresh();
        }

        protected string ClassName =>
            new CssBuilder("table")
                .AddClass("table-striped", Striped)
                .AddClass("table-" + (Bordered ? "bordered" : "borderless"))
                .AddClass("table-hover", Hoverable)
                .AddClass(Class)
            .Build();

        public void Refresh()
        {
            InvokeAsync(StateHasChanged);
        }

        private void GetData()
        {
            try
            {
                _entities = (List<TableItem>)PagedListMethod(CurrentPage,
                                                            this.PageSize,
                                                            _orderList,
                                                            FilterList,
                                                            out _paginationInfo);
            }
            catch (Exception)
            {
                _navigationManager.NavigateTo("/Error500");
            }
        }

        public void SortTable(IColumn<TableItem> column)
        {
            if (column.Sortable && column.Field != null)
            {
                switch (column.SortDirection)
                {
                    case SortDirection.None:
                        column.SortDirection = SortDirection.Ascending;
                        _sortFields.Add(column);
                        break;
                    case SortDirection.Ascending:
                        column.SortDirection = SortDirection.Descending;
                        break;
                    case SortDirection.Descending:
                        column.SortDirection = SortDirection.None;
                        _sortFields.Remove(column);
                        break;
                }

                _orderList = _sortFields.Count == 0 ? "Id," : string.Empty;

                StringBuilder builder = new StringBuilder(_orderList);

                foreach (IColumn<TableItem> item in _sortFields)
                {
                    builder.Append(item.Field.GetPropertyMemberInfo().Name);
                    builder.Append(item.SortDirection == SortDirection.Descending ? " DESC" : string.Empty);
                    builder.Append(',');
                }

                builder.Length--;
                _orderList = builder.ToString();

                GetData();
            }
        }

        public void FirstPage()
        {
            if (CurrentPage != 1)
            {
                CurrentPage = 1;
                GetData();
            }
        }

        public void NextPage()
        {
            if (CurrentPage < _paginationInfo.TotalPages)
            {
                CurrentPage++;
                GetData();
            }
        }

        public void PreviousPage()
        {
            if (CurrentPage > 1)
            {
                CurrentPage--;
                GetData();
            }
        }

        public void LastPage()
        {
            if (CurrentPage != _paginationInfo.TotalPages)
            {
                CurrentPage = _paginationInfo.TotalPages;
                GetData();
            }
        }

        private void AddEntity()
        {
            _navigationManager.NavigateTo(AddURI);
        }

        private void OnEdit(string id, string Url)
        {
            if (EditEventCallBack.HasDelegate)
            {
                EditEventCallBack.InvokeAsync(new KeyValuePair<int, string>(int.Parse(id), typeof(TableItem).Name));
            }
            else
                _navigationManager.NavigateTo(Url);
        }

        private async Task CancelRoute()
        {
            if (ReturnRouter != null)
            {
                _call += ReturnRouter;
                var ReturnUri = await _call.Invoke(CancelURI);

                if (ReturnUri != null)
                {
                    _navigationManager.NavigateTo(ReturnUri);
                }
                else if (CancelURI != null)
                {
                    _navigationManager.NavigateTo(CancelURI);
                }
            }
            else if (CancelURI != null)
            {
                _navigationManager.NavigateTo(CancelURI);
            }

        }
        private void CancelPage()
        {
            _navigationManager.NavigateTo(CancelURI);
        }

        private void ChangePageSize(ChangeEventArgs e)
        {
            CurrentPage = 1;
            PageSize = e.Value.ToString().ToValue<int>();
            GetData();
        }

        private void DeleteEntity(int id)
        {
            _currentEntityId = id;
            _showYesNoDialog = true;
        }

        public async Task DeleteEntityAsync(bool isDelete)
        {
            _showYesNoDialog = false;
            StateHasChanged();

            if (isDelete)
            {
                try
                {
                    await DeleteMethod(_currentEntityId).ConfigureAwait(false);
                    _toastService.ShowToast(ToastLevel.Success, "Record deleted successfully");
                    GetData();
                }
                catch (Exception)
                {
                    _toastService.ShowToast(ToastLevel.Warning, "Record can't be deleted");
                }
            }
        }
    }
}

#nullable enable