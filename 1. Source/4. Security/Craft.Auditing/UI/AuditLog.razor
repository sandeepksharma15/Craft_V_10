@namespace Craft.Auditing.UI

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudDatePicker Label="From Date" @bind-Date="_fromDate" DateFormat="dd MMM yyyy" />
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudDatePicker Label="To Date" @bind-Date="_toDate" DateFormat="dd MMM yyyy" />
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="string?" Label="Table Name" @bind-Value="_selectedTableName" Clearable="true">
                @foreach (var table in _tableNames)
                {
                    <MudSelectItem T="string?" Value="@table">@table</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="EntityChangeType?" Label="Change Type" @bind-Value="_selectedChangeType" Clearable="true">
                @foreach (var ct in Enum.GetValues<EntityChangeType>())
                {
                    <MudSelectItem T="EntityChangeType?" Value="@((EntityChangeType?)ct)">@ct.ToString()</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="long?" Label="Changed By" @bind-Value="_selectedUserId" Clearable="true">
                @foreach (var user in _auditUsers)
                {
                    <MudSelectItem T="long?" Value="@((long?)user.UserId)">@user.DisplayName</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" Class="d-flex gap-2">
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@ApplyFiltersAsync"
                       StartIcon="@Icons.Material.Filled.FilterAlt">Apply</MudButton>
            <MudButton Color="Color.Default" Variant="Variant.Outlined" OnClick="@ClearFiltersAsync"
                       StartIcon="@Icons.Material.Filled.FilterAltOff">Clear</MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

<Show When="@_filtersActive">
    <MudAlert Severity="Severity.Info" Class="mb-3" Icon="@Icons.Material.Filled.FilterAlt">
        Filters are active. <MudLink OnClick="@ClearFiltersAsync">Clear all filters</MudLink>
    </MudAlert>
</Show>

<CraftDataGrid TEntity="AuditTrail" @ref="_dataGrid" HttpService="@_auditService"
               QueryBuilder="@BuildQueryFilter()" AllowView="true" OnView="@ViewDiffAsync"
               ShowSearch="false" AllowRefresh="true">

    <CraftDataGridColumn TEntity="AuditTrail" PropertyExpression="@(x => x.DateTimeUTC)"
                         Title="Date / Time" DefaultSort="GridSortDirection.Descending" Sortable="true">
        <Template>
            <MudStack Spacing="0">
                <MudText Typo="Typo.body2">@context.DateTimeUTC.ToLocalTime().ToString("dd MMM yyyy")</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.DateTimeUTC.ToLocalTime().ToString("HH:mm:ss")</MudText>
            </MudStack>
        </Template>
    </CraftDataGridColumn>

    <CraftDataGridColumn TEntity="AuditTrail" PropertyExpression="@(x => x.TableName)"
                         Title="Table" Sortable="true" />

    <CraftDataGridColumn TEntity="AuditTrail" PropertyExpression="@(x => x.ChangeType)"
                         Title="Change Type" Sortable="true">
        <Template>
            <MudChip T="string" Color="@GetChangeTypeColor(context.ChangeType)"
                     Icon="@GetChangeTypeIcon(context.ChangeType)" Size="Size.Small">
                @context.ChangeType.ToString()
            </MudChip>
        </Template>
    </CraftDataGridColumn>

    <CraftDataGridColumn TEntity="AuditTrail" PropertyExpression="@(x => x.UserId)"
                         Title="Changed By" Sortable="false">
        <Template>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Color="Color.Secondary" />
                <MudText Typo="Typo.body2">@GetUserDisplayName(context.UserId)</MudText>
            </MudStack>
        </Template>
    </CraftDataGridColumn>

    <CraftDataGridColumn TEntity="AuditTrail" PropertyExpression="@(x => x.KeyValues)"
                         Title="Key" Sortable="false">
        <Template>
            <MudTooltip Text="@context.KeyValues">
                <MudText Typo="Typo.body2">
                    @(context.KeyValues?.Length > 30 ? context.KeyValues[..30] + "…" : context.KeyValues)
                </MudText>
            </MudTooltip>
        </Template>
    </CraftDataGridColumn>

    <CraftDataGridColumn TEntity="AuditTrail" PropertyExpression="@(x => x.ChangedColumns)"
                         Title="Changed Columns" Sortable="false">
        <Template>
            <MudTooltip Text="@context.ChangedColumns">
                <MudText Typo="Typo.body2">
                    @(context.ChangedColumns?.Length > 40 ? context.ChangedColumns[..40] + "…" : context.ChangedColumns)
                </MudText>
            </MudTooltip>
        </Template>
    </CraftDataGridColumn>

</CraftDataGrid>
